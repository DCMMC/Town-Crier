\vspace{-2mm}
\section{Introduction}
\vspace{-2mm}

Smart contracts are computer programs that autonomously execute the terms of a contract.
For decades they have been envisioned as a way to use logical specification to render legal agreements more precise, pervasive, and efficiently executable.
Szabo, who popularized the term ``smart contact'' in a seminal 1994 essay~\cite{szabosmartcontract94}, gave as an example a smart contract that enforces car loan payments. If the owner of the car fails to make a timely payment, a smart contract could programmatically revoke physical access and return control of the car to the bank. %The contract could additionally be programmed to do so only at a time that is safe for the the owner, e.g., while the car is parked.

Cryptocurrencies such as Bitcoin~\cite{bitcoin} have provided key technical provisions for decentralized smart contracts: direct control of money by programs and fair, automated execution of computations through the decentralized consensus mechanisms underlying  blockchains. 
The recently launched Ethereum supports Turing-complete code and thus fully expressive, self-enforcing smart contracts, a big step toward the vision of researchers and proponents.  

As Szabo's example shows, however, the most compelling applications of smart contracts require not just blockchain code, but access to data about real-world state and events. Similarly, financial contracts and derivatives, key applications for Ethereum~\cite{yellowpaper,whitepaper}, rely on data about financial markets such as equity prices. %Applications such as insurance policies are only realizable with data about weather, flights, delivery of goods, and so forth. 

\emph{Data feeds}---contracts on the blockchain that serve data requests by other contracts~\cite{whitepaper,yellowpaper}---are intended to meet this need. A few data feeds exist for Ethereum today, but provide no assurance of trustworthy data beyond the reputation of their operators (who are typically individuals or small entities), even if their data originates with trustworthy sources. Of course, there exist reputable websites that serve data for non-blockchain applications and use HTTPS, enabling source authentication of served data. Smart contracts, though, lack network access and thus cannot directly access such data. The lack of a substantive ecosystem of trustworthy data feeds thus remains an oft-cited, critical obstacle to the evolution of in Ethereum and smart contracts 
in general~\cite{commblockstream}.

%\vspace{-2mm}
\paragraph{\bf Town Crier.} We introduce a system called \emph{Town Crier} (\tc) that provides an \emph{authenticated data feed} (ADF) for smart contracts. \tc acts as a high-trust bridge between existing HTTPS-enabled data websites and the Ethereum blockchain. It retrieves website data and serves it to relying contracts on the blockchain as concise, contract-consumable pieces of data (e.g., stock quotes) called \emph{datagrams}. \tc makes use of Software Guard Instructions (SGX),  Intel's recently released trusted hardware capability. It executes its core functionality as a trusted piece of code in an SGX \emph{enclave}, which protects against malicious processes and the OS and can \emph{attest} (prove) to a remote client that the client is interacting with a legitimate, SGX-backed instance of the \tc code. 

Through a smart-contract front end, \tcs responds to requests by contracts on the blockchain with attestations of the following form:

\begin{itemize}[leftmargin=3mm]
\item[]
\noindent {``Datagram $X$ specified by parameters $\dgform$ is  
served by an HTTPS-enabled website $Y$ 
during a specified time frame $T$.''}
\end{itemize}

A relying contract can be assured of the correctness of $X$ in such a datagram if it trusts the security of SGX, the (published) \tc code, and the validity of source data in the specified interval of time.

%\vspace{-2mm}
\paragraph{Contributions of \tc.}
We highlight several important contributions in our design of \tc:

\vspace{2mm}
\noindent{\em Fully functional \tc implementation, with pending open source and launch.}
We designed and implemented \tcs as a complete, end-to-end system that offers formal security guarantees
at the cryptographic protocol level. Aiming beyond an advance in academic research, we plan to launch \tcs
as an open-source, production service atop Ethereum in the near future. Our launch of \tc awaits only availability of the Intel Attestation Service (IAS), which is expected to occur soon. In its initial form, \tcs be a free service for smart contract users, requiring users only to defray the (small) cost of invoking \tc on the Ethereum blockchain. 

\vspace{2mm}
\noindent{\em Formal security analysis.}
Formal security is vitally important to a data feed.
Smart contracts execute in an adversarial environment where parties can reap financial gains by subverting the contracts or the services on which they rely.
Legal recourse is often impractical precisely because of several benefits smart contracts provide;
they enable micro-services without costly legal setup and enforcement and allow contracts between arbitrary pseudonymous parties.
We thus adopt a rigorous, principled approach to the design of \tcs by formally defining and ensuring: 

%\vspace{-1mm}
\begin{itemize}[leftmargin=5mm]
\item
  \setlength{\itemsep}{2pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
{\it Authenticity}: A datagram $X$ returned
to a requesting contract is guaranteed
to truly reflect the data served by specified website $Y$ in time interval $T$ with the requester's specified parameters $\dgform$.
\item
{\it Gas neutrality (zero \tc loss).} Assuming that \tc executes honestly, it does not lose money (cannot suffer resource depletion)
even when accessed by arbitrarily malicious blockchain contracts and users.
\item
{\it Fair expenditure (bounded requester loss).} 
Even when all other users, contracts, and \tc itself act maliciously, 
an honest requester will never pay more than a tiny amount beyond what is required for valid computation executed for that request---whether or not a datagram is delivered.
\end{itemize}
\vspace{-1mm}

To obtain the above formal guarantees,
we rely on the formal modeling 
of blockchains proposed by Kosba et al.~\cite{hawk} and the formal abstraction for SGX proposed by Shi et al.~\cite{sgxsok}
Our analysis of \tc reveals interesting challenges and technical subtleties, e.g., 
a subtle gap between the formal blockchain model
of Kosba et al.~\cite{hawk}
and Ethereum's instantiation  
that proves important in formal reasoning about \tc's handling of fees. 

\vspace{2mm}
\noindent{\em Robustness to component compromise.}
\tc minimizes the Trusted Computing Base (TCB) of its trusted code in the SGX enclave.
It thus offers a basic security model in which a user need only trust SGX itself and a designated data source (website).
As an additional feature, \tc can hedge against the risk of compromise of a website or single SGX instance
by supporting various modes of majority voting:
among multiple 
websites offering the same piece of data (e.g., stock price),  
or among multiple, possibly geographically dispersed, SGX instances.

\vspace{2mm}
\noindent{\em Private and custom datagrams.} To meet the potentially complex confidentiality concerns that can arise in the broad array of smart contracts enabled by \tc, \tc's trusted enclave code is instrumented to ingest confidential user data (encrypted under a \tc public key). It can thereby support {\em private} datagram requests, with encrypted parameters, and {\em custom} datagram requests, which securely access the online resources of requesters (e.g., online accounts) using encrypted credentials. 

\vspace{2mm}
Additionally, to the best of our knowledge, ours is the first research paper reporting implementation of a substantive system on a real, SGX-enabled host, as opposed to an emulator (e.g.,~\cite{haven,VC3}).

%\vspace{-3mm}
\paragraph{Applications.} Thanks to the above key contributions, we believe that \tc can spur deployment of a rich spectrum of smart contracts that are hard to realize in the existing Ethereum ecosystem. We present three examples that showcase \tc's capabilities and demonstrate its end-to-end use: (1) A financial derivative (cash-settled put option) that consumes stock ticker data; (2) A flight insurance contract that relies on private data requests about flight cancellations; and (3) A contract for sale of virtual goods and online games (via Steam Marketplace) for ether, the Ethereum currency, using custom data requests to access online user accounts. We experimentally measure response times for associated datagram requests ranging from 192-1309 ms, depending on the datagram type. These times are significantly less than an Ethereum block interval, and suggest that a few SGX-enabled hosts can support \tc data feed rates well beyond the global transaction rate of a modern decentralized blockchain.

%\vspace{-2mm}
\paragraph{\em Organization:} We present basic technical background for \tc (Section~\ref{sec:background}), followed by an architectural description (Section~\ref{sec:architecture}), a basic set of protocols (Section~\ref{sec:protocols}), the full, enhanced system protocols (Section~\ref{sec:enhanced_protocol}), and a formal security analysis (Section~\ref{sec:analysis}). We then present three example applications (Section~\ref{sec:applications}) which we use as the basis for performance evaluations of \tc (Section~\ref{sec:experiments}).  After presenting related work (Section~\ref{sec:related}), we conclude the paper (Section~\ref{sec:conclude}). The paper appendix includes implementation details, formal modeling and proofs, and future directions omitted from the paper body.







