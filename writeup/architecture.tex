 \section{\tc Architecture and Security Model}
 \label{sec:architecture}

The \tcs system includes three main components: The \tcontract (\tcont), the \encname (whose code is denoted by \engine), and the \medname (\relay). The \encname and \medname reside on the \tc server, while the \tcontract  resides on the blockchain. We denote a smart contract making use of the \tcs service as a {\em requester} or {\em relying} contract; we denote this contract by $\reqcont$, and its (off-chain) owner as a \emph{client} or \emph{user}. A \emph{data source}, or \emph{source} for short, is an online server (running HTTPS) that provides data which \tc draws on to compose datagrams. 

An architectural schematic of \tc showing its interaction with external entities is given in Figure~\ref{fig:overview}.

\subsection{Basic terminology}



\begin{figure}[h!]
\centering
\begin{tikzpicture}
  [tc-entity/.style={entity,minimum height=3.5em,text width=3.5em},
   contract/.style={entity,minimum height=3.5em,text width=5.7em}]
  \node[contract,trusted] (ctc) {TC Contract\\$\tcont$};
  \node[contract,fill=white,below=1.5em of ctc] (cu) {User Contract\\$\reqcont$};
  \node[tc-entity,fill=none,right=2.5em of ctc] (relay) {Relay\\$\relay$};
  \node[tc-entity,trusted,right=2.5em of cu] (enc) {Enclave\\$\enclaveprog$};

  \begin{pgfonlayer}{background}
    \node[bg-box,
          blockchain-color,
          fit={($(ctc.north east)+(0.5em,0.5em)$)($(cu.south west)+(-0.5em,-0.5em)$)},
          label=above:{\bf Blockchain}] (blockchain) {};
    \node[rectangle,
          draw=black,
          tc-server-color,
          inner sep=0,
          fit={($(relay.north east)+(0.5em,0.5em)$)($(enc.south west)+(-0.5em,-0.5em)$)},
          label=above:{\bf TC Server}] (tc) {};
  \end{pgfonlayer}

  \node[right=-0.1em of tc,communication,transform canvas={yshift=2.5em}] (https) {\scriptsize \bf HTTPS};
%  \node[rectangle,draw=black,trusted,right=2.75em of tc,text width=4.5em,minimum height=9.75em,align=center,label=above:{\bf Data Source}] (data) {\tt lots-o-\\data.com};
  \node[cloud,draw=black,trusted,cloud puffs=11,cloud puff arc=100,aspect=0.6,inner xsep=-0.35em,right=2.5em of tc,text width=4.15em,align=center] (data) {\tt lots-o-\\data.com};
  \node[minimum height=9.5em,minimum width=4em,label=above:{\bf Data Source}] () at (data) {};

  \draw[stealth-stealth,comm-link] ([xshift=-0.75em,yshift=-0.75em]ctc.east) -| ([xshift=-0.75em,yshift=-0.75em]enc.north);
  \draw[stealth-stealth,comm-link] ([yshift=0.75em]ctc.south) -- ([yshift=-0.75em]cu.north);
  \draw[stealth-stealth,comm-link] ([xshift=0.75em,yshift=-0.75em]enc.north) |- ([xshift=1.1em,yshift=1.75em]data.west);
\end{tikzpicture}
\caption{{\bf Basic Town Crier architecture.} Trusted components are depicted in green.}
\label{fig:overview}
\end{figure}



\paragraph{The \tcontract \tcont.} The \tcontract (denoted by \tcont) is a smart contract that acts as the blockchain front end of the \tc service. It is designed to present a simple API to a relying contract \reqcont for its requests to \tc. Very simply, \tcont accepts datagram requests from a requester \reqcont and returns corresponding datagrams from \tc. Additionally, \tcont manages \tc monetary resources, which in Ethereum take the form of ether (money) and gas (``fuel'' for contracts).

\paragraph{The \encname.}
We refer to an instance of the TC code running in an SGX enclave simply as the \encname and denote the code itself by  \engine. In TC, the \encname ingests and fulfills datagram requests from the blockchain. To obtain the data for inclusion in datagrams, it queries external data sources, specifically HTTPS-enabled internet services. It returns a datagram to a requesting contract \reqcont as a digitally signed blockchain message. Under our assumed security model for SGX, apart from its network functions, the \encname runs in complete isolation from an adversarial OS as well as other process on the host. 

\paragraph{The \medname \relay.} As an SGX enclave process, the \encname lacks direct network access. Thus the \medname handles bidirectional network traffic on behalf of the \encname. Specifically, the \medname provides network connectivity from the \encname to three different types of entities: 

\begin{enumerate}
\item {\em The Blockchain (the Ethereum system):}  The \medname scrapes the blockchain in order to monitor the state of the \tcontract  \tcont. In this way, it performs implicit message passing from \tcont to the \encname, as neither component itself has network connectivity. Additionally, the \medname places messages emitted from the \encname (datagrams) on the blockchain.
\item {\em Clients:} The \medname runs a web server to handle off-chain service requests from clients, specifically, requests for attestations from the \encname. As we soon explain, an attestation provides a unique public key for the \encname instance to the  client and proves that the \encname is executing correct code in an enclave and that its clock is correct in terms of absolute (wall-clock time). A client that successfully verifies an attestation can then safely create a relying contract \reqcont that uses the \tc.
\item {\em Data sources:} The \medname relays traffic to and from data sources (HTTPS-enabled servers) queried by the \encname. 
\end{enumerate}

The \medname is an ordinary user-space application. It does not benefit from integrity protection by SGX and thus, unlike the \encname, can be subverted by an adversarial OS on the \tc server, causing network delays or failures. A key design aim of \tc, however, is that \medname should be unable to cause incorrect datagrams to be produced or users to lose fees paid to \tc for datagrams (although they may lose gas used to fuel their requests). As we shall show, in general the \medname~{\em can only mount denial-of-service attacks against \tc}. 

\paragraph{Security model}

Here we give a brief overview of our security model for \tc, providing more details in later sections. We assume the following:

\begin{itemize}
  \setlength{\itemsep}{2pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}

\item {\em The TC Contract.} \tcont is globally visible on the blockchain and its source code is published for clients. Thus we assume that \tcont behaves honestly.

\item {\em Data sources.} We assume that clients trust the data sources from which they obtain \tc datagrams.

\item {\em \encname security.} We make three assumptions about the \encname : (1) The \encname behaves honestly, i.e., \engine, whose source code is published for clients, correctly executes the \tc protocol; (2) For an \encname-generated keypair $(\skTC, \pkTC)$, the private key $\skTC$ is known only to the \encname; and (3) The \encname has an accurate (internal) real-time clock. We explain below how we achieve these properties through use of SGX. 


\item {\em Blockchain communication.} Transaction and message sources are authenticable, i.e., a transaction $m$ sent from an account ${\cal P}_{X}$ (or message $m$ from contract ${\cal C}_{X}$) is identified by the receiving account as originating from $X$. Transactions and messages are integrity protected (as they are digitally signed by the sender), but not confidential. 

\item {\em Network communication.} The \medname (and other untrusted components of the \tc server) can tamper with or delay communications to and from the \encname. (As we explain in our SGX security model, the \medname cannot otherwise observe or alter the behavior of the \encname.) Thus the \medname is subsumed by an adversary that controls the network. 

\end{itemize}












