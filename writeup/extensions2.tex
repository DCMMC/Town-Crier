
\section{Handling gas as implemented}

\ethan{This section is a writeup of the things that need to change to make sure that protocol with fees conforms more precisely to the implementation.}

\subsection{Handling Transaction Fees}

To mitigate potential Denial-of-service (DoS) attacks, Ethereum employs a fee mechanism, referred to as ``gas'',
where the user requesting a transaction (that can invoke an entry point to a contract) pays a transaction fee.
The fee is proportional to the computation required to execute the specified transaction.


\paragraph{Notations and assumed execution model.}
In this section we use the notation $\gas$ to denote transaction fees (i.e. gas) and $\fee$ to denote non-gas currency.
In both cases \$ is a type annotation and the letter denotes the numerical amount.
For simplicity, our notation assumes that gas and normal currency adopt the same units.

We assume the blockchain contract adopts the following execution model which closely resembles that of Ethereum described in Section \ethan{refer}.

\begin{itemize}[leftmargin=1.5em]
  \item {\it Providing gas.}
    When a transaction is submitted, it invokes an entry point in the contract and provides a gas amount.

  \item {\it Extra gas.}
    If the provided gas exceeds the gas necessary to process the transaction, all excess gas is refunded as part of the transaction.

  \item {\it Gas exhaustion.}
    Consider each entry point a function call.
    If a function calls another function, the parent may limit the gas available to the child to a value no higher than the gas available to the parent.
    When a function cannot complete execution within its gas limit,
    that function execution is aborted and all state is reverted to immediately prior to that call.
    Note that if the initial entry point runs out of gas, the entire transaction is aborted.

\end{itemize}

We use the following notations to denote regular currency units and gas.
%
\begin{center}
\begin{tabular}{m{0.1\columnwidth}m{0.83\columnwidth}}
  \hline
  $\fee$
  & Currency a requester deposits to refund Town Crier's gas advance to deliver a datagram \\
  \hline
  $\gasdeliver$ $\gasrequest$
  & Gas attached when invoking the {\bf Deliver} and {\bf Request} entries points, respectively \\
  \hline
  $\constgasmin$
  & Gas needed for the {\bf Deliver} entry point when $\dgcallback$ is empty \\
  \hline
  $\constgasmax$
  & The maximum amount of gas Town Crier can supply when invoking {\bf Deliver.} \\
  \hline
\end{tabular}
\end{center}
%
Note that $\constgasmin$ and $\constgasmax$ are system constants,
$\fee$ is chosen by the requester (and may be malicious if the requester is dishonest),
and $\gasdeliver$ is chosen by the \tc~\encname when calling {\bf Deliver}.
$\gasrequest$ and $\gascancel$ are set by the requester upon creating or cancelling a request,
but if they are too small then Ethereum will abort the transaction as if it were never called,
so we need not worry about them being malicious.


%\begin{figure}
%\centering
%\begin{tikzpicture}
%  [local-entity/.style={entity,minimum height=3.5em,text width=8em}]
%  \node[local-entity,trusted] (ctc) {};
%  \node[local-entity,draw=none,anchor=north] (ctc-inner) at (ctc.north) {TC Contract\\$\tcont$};
%  \node[local-entity,trusted,right=6em of ctc,text width=5em] (enc) {Enclave};
%  \node[local-entity,fill=white,below=3.5em of ctc] (cu) {User Contract\\$\reqcont$};
%  \node[local-entity,fill=red!30,below=2.5em of cu] (user) {User};
%
%  \path[-stealth,color=red,ultra thick] (user) edge [transform canvas={xshift=-3.5em}] ([yshift=0.75em]cu.south);
%  \path[color=red,thick] (cu.south) edge [right,transform canvas={xshift=-3.5em}] node [text=black,text width=4em,align=center,yshift=1.75em] {\footnotesize Insufficient\\[-0.25em]gas aborts\\[-0.2em]with no\\[-0.5em]effect} (ctc.south);
%  \node[draw=red,cross out,minimum size=1ex,thick] () at ([xshift=-3.5em]ctc.south) {};
%
%  \draw[-stealth,color=green!50!black,line width=0.8ex] ([yshift=-0.25em]enc.west) -- ([xshift=-1.2em,yshift=-0.25em]ctc.east);
%  \draw[-stealth,color=green!50!black,line width=0.5ex] ([yshift=-0.25em]enc.west) -| ([xshift=3em,yshift=-0.9em]cu.north);
%  \draw[color=green!50!black,thick,dashed]  ([xshift=3.75em]cu.north) |- ([yshift=-1.25em]ctc.east);
%  \path[-stealth,color=green!50!black,ultra thick,dashed]  ([yshift=-1.25em]ctc.east) edge [below] node [text=black,text width=4em,align=center,xshift=-0.4em] {\footnotesize Extra gas\\[-0.4em]refunded} ([xshift=0.8em,yshift=-1.25em]enc.west);
%
%  \begin{pgfonlayer}{background}
%    \node[bg-box,
%          blockchain-color,
%          fit={($(ctc.north west)+(-0.5em,0.5em)$)($(cu.south east)+(0.5em,-0.5em)$)},
%          label=above:{\bf Blockchain}] () {};
%    \node[bg-box,
%          tc-server-color,
%          fit={($(enc.north east)+(0.5em,0.5em)$)($(enc.south west)+(-0.5em,-0.5em)$)},
%          label=above:{\bf TC Server}] () {};
%  \end{pgfonlayer}
%\end{tikzpicture}
%\caption{{\bf Gas Payment in Ethereum}}
%\label{fig:gas-model}
%\end{figure}



\begin{figure}
\begin{tabularx}{\linewidth}{|@{\hspace{3pt}}r@{\hspace{1ex}}X@{\hspace{3pt}}|}
  \hline

  \multicolumn{2}{|c|}{{\bf Town Crier blockchain contract \tcont with fees}} \\[1ex]
  {\bf Request:} & On recv $({\sf params}, {\sf callback}, \gasrequest + \fee)$ from some $\reqcont$: \\
                 & Assert $\constgasmin \leq \fee \leq \constgasmax$ \\
                 & $\dgid := \text{Counter}$; \ \ $\text{Counter} := \text{Counter} + 1$ \\
                 & Store $(\dgid, \dgform, \dgcallback, \fee)$ \\[-0.8em]
                 & {\it \sgray{//~$\fee$ held by contract}} \\

  {\bf Deliver:} & On recv $(\dgid, \dgform, \dgm, \gasdeliver)$ from $\tcadd$: \\
                 & Retrieve stored $(\dgid, \dgform', \dgcallback, \fee)$ \\
                 & \quad \sgray{\it //~abort if not found} \\
                 & Assert $\dgform = \dgform'$ \\
                 & Assert $\fee \leq \gasdeliver$ \\
                 & Send $\fee$ to \tcadd \\
                 & Call $\dgcallback(\dgm)$ with $\fee - \constgasmin$ max gas \\
  \hline
\end{tabularx}
\caption{
Town Crier contract \tcont reflecting fees.
An honest requester sets $\fee$ to be the gas amount
required to execute the {\bf Deliver} entry point including $\dgcallback$.
Town Crier sets $\gasdeliver := \constgasmax$, but limits gas provided for $\dgcallback$ ensure that no more than $\fee$ is spent.
Ethereum automatically refunds any unspent gas, so Town Crier will not lose money.
}
\label{tbl:tc-contract2}
\end{figure}

\begin{figure}[!h]
\begin{boxedminipage}{\columnwidth}
\centering
{\bf Program for \tcs~\encname ($\enclaveprog$)} \\[1ex]
\begin{tabular}{l}
{\bf Initialize}: Same as Figure \ethan{refer} \\[3pt]

{\bf Resume:} On recv $(\resumecall, (\dgid, \dgform))$ \\
\quad Same as before except the last two statements: \\
\quad $\sigma := \Sigma.{\sf Sign}({\skTC}, (\dgid, \dgform, \dgm, \constgasmax))$ \\
\quad Output $((\dgid, \dgform, \dgm, \constgasmax), \sigma)$ \\
\end{tabular}
\end{boxedminipage}
\caption{The \tcs~\encname \engine.}
\label{fig:engineprot}
\end{figure}

\begin{figure}
\centering
\begin{tikzpicture}
  [contract/.style={entity,minimum height=3.5em,text width=7.5em},
   wallet/.style={entity,minimum height=3.5em,text width=5em},
   type-box-color/.style={fill=black!10},
   blocked-out-label/.style={text=black,type-box-color,text height=0.6em}]
  \node[wallet,fill=white] (user) {User ${\cal P}_U$};
  \node[contract,fill=white,right=6em of user] (cu) {User Contract\\$\reqcont$};
  \node[wallet,trusted,below=5em of user] (tc-wallet) {$\tcadd$};
  \node[contract,trusted,right=6em of tc-wallet] (ctc) {TC Contract\\$\tcont$};
  \node[color=maroon,draw,anchor=south east] (fee) at ([xshift=-0.25em,yshift=0.25em]ctc.south east) {\small $\fee$};

  \draw[color=gold,opacity=0.35,line width=1ex] ([yshift=1.25em]user.east) -| ([xshift=3.25em]cu.south);
  \path[-stealth,color=gold,line width=1.15ex] (user) edge [transform canvas={yshift=1.25em}] (cu);
  \path[-stealth,color=gold,line width=1ex] (cu) edge [transform canvas={xshift=3.25em}] (ctc);
  \path[-stealth,color=maroon,line width=0.4ex] (cu.south) edge [left,transform canvas={xshift=3.25em}] node [blocked-out-label,xshift=1em,yshift=1.2em] {\small \smash{$(\gasrequest, \fee)$}} ([yshift=-1.5em]ctc.north);
  \node[anchor=north,xshift=1em,yshift=-0.75em] () at (cu.south) {\small \bf \underline{\smash{Request}}};

  \path[-stealth,color=gold,line width=1ex] (tc-wallet.east) edge [above,transform canvas={yshift=0.4em}] node () {\small $\gasdeliver$} (ctc.west);
  \draw[color=gold,opacity=0.35,line width=0.3ex] ([yshift=0.4em]tc-wallet.east) -| ([xshift=-3em]ctc.north);
  \path[-stealth,color=gold,line width=0.3ex] (ctc.north) edge [transform canvas={xshift=-3em}] node [blocked-out-label,xshift=0.9em,yshift=-1.25em] {\small \smash{$\fee - \constgasmin$}} (cu.south);
  \path[color=maroon,opacity=0.35,ultra thick] (tc-wallet-|fee.west) edge [transform canvas={yshift=-1.2em}] (tc-wallet.east);
  \path[-stealth,color=maroon,ultra thick] (ctc.west) edge [transform canvas={yshift=-1.2em}] node [blockchain-color,xshift=0.4em] {\small $\fee$} ([xshift=-0.8em]tc-wallet.east);
%  \path[-stealth,color=gold,ultra thick,dashed] (ctc.west) edge [below,transform canvas={yshift=-1em}] node [text=black,xshift=0.4em] {\small $\gasdeliver - \fee$} ([xshift=-0.8em]tc-wallet.east);

  \path[] (tc-wallet.north east) edge [draw=none,above] node [yshift=0.75em] {\small \bf \underline{Deliver}} (ctc.north west);

  \begin{pgfonlayer}{background}
    \node[bg-box,
          blockchain-color,
          fit={($(ctc.south east)+(1em,-1em)$)($(user.north west)+(-1em,2em)$)},
          label=above:{\bf Blockchain}] () {};
    \node[bg-box,
          type-box-color,
          fit={($(ctc.south east)+(0.5em,-0.5em)$)($(cu.north west)+(-0.5em,0.5em)$)},
          label=above:{\bf Contracts}] () {};
    \node[bg-box,
          type-box-color,
          fit={($(tc-wallet.south east)+(0.5em,-0.5em)$)($(user.north west)+(-0.5em,0.5em)$)},
          label=above:{\bf Wallets}] () {};
  \end{pgfonlayer}
\end{tikzpicture}
\caption{{\bf Blockchain Money Flow within Town Crier.}
Red arrows denote flow of money and brown arrows denote gas provided for function execution.
The thickness of the line indicates the quantity of the resource.
The thin brown line labeled $\fee - \constgasmin$ is a call from \tcont to \dgcallback with a gas limit based on the value of $\fee$ for that request.
}
\label{fig:money-flow}
\end{figure}



\paragraph{Town Crier protocol with transaction fees.}
Our basic Town Crier system implements a policy where the requester pays for all gas needed and Town Crier effectively pays nothing.
We now describe how this can be realized by modifying the fee-free protocol described in Section \ethan{refer}.

\begin{itemize}[leftmargin=1.5em]
  \item {\it Initialization.}
    We assume that Town Crier deposits at least $\constgasmax$ into the wallet $\tcadd$.

  \item {\it Town Crier blockchain contract.}
    Figure \ref{tbl:tc-contract2} describes the Town Crier blockchain contract reflecting fees.
    Since Town Crier's account $\tcadd$ has to invoke the {\bf Deliver} entry point, it advances a gas payment $\constgasmax$.
    We prove in Section \ethan{ref-gas-neutrality} that this is always enough gas and providing extra is not a problem.

  \item {\it Town Crier Relay.}
    The relay behavior does not change with the presence of fees.
    It still monitors the blockchain and whenever the contract \tcont stores a new request $(\dgid, \dgform, \_, \_, \_)$,
    it invokes $\enclaveprog$ with $\resumecall(\dgid, \dgform)$.

  \item {\it Town Crier enclave.}
    We make the following small modification to the fee-free protocol.
    Instead of signing the tuple $(\dgid, \dgform, \dgm)$ at the end of its execution,
    the enclave now signs the tuple $(\dgid, \dgform, \dgm, \gasdeliver)$ where $\gasdeliver = \constgasmax$.

  \item {\it Requester.}
    An honest requester behaves the same was as in Figure \ethan{refer} except for sending $\gasrequest$ gas and $\fee$ money with each request.
    It sets $\gasrequest$ to be at least the cost of executing the {\bf Request} entry point
    and $\fee$ to be the cost of executing the {\bf Deliver} entry point (including executing the user-defined $\dgcallback$ function).
\end{itemize}

These changes do not modify the properties on which our authenticity proof in Section \ethan{ref authenticity} relied, so that result still holds.
We will prove in Section \ethan{refer} that this new protocol ensures that \tc cannot lose gas when the \medname is honest
and that an honest requester's loss is limited even against a malicious \tc.




\subsection{Gas Neutrality}


\begin{theorem}[Gas neutrality for Town Crier]
Assuming an honest Town Crier relay,
Town Crier's wallet account $\tcadd$ will have at least $\constgasmax$ remaining after each {\bf Deliver} call.
\end{theorem}

\begin{proof}[(sketch)]
Honest relay means $\resumecall(\dgid, \dgform)$ will always be legitimate and $\dgform = \dgform'$ in {\bf Deliver}.
While $\fee$ is specified by a potentially malicious user, \tcont rejects the request unless $\constgasmin \leq \fee \leq \constgasmax$.
This means $\gasdeliver = \constgasmax \geq \fee$.
We also will never respond to the same request twice (these are specified in the enclave protocol), so we will never abort.

We limit the gas provided to $\dgcallback$ to $\fee - \constgasmin$ (which must be positive because of the check in {\bf Request}),
and $\constgasmin$ is set so that it is at least the cost of {\bf Deliver} not including $\dgcallback$.
This means that the total gas used is no greater than $\constgasmin + (\fee - \constgasmin) = \fee$, which is exactly what $\tcadd$ is sent for reimbursement.
We also don't run out of gas because $\fee \leq \constgasmax = \gasdeliver$, so we cannot use more gas than we provide.
\end{proof}


\begin{theorem}[Bounded loss for honest requester]
For any request $(\dgform, \dgcallback, \fee)$ submitted by an honest user $\reqcont$,
the requester will lose no more than $\gasrequest + \constgasmax$ money.
\end{theorem}

\begin{proof}[(sketch)]
In Ethereum, all money must be sent by the address controlling that money.
An honest user will only send $\gasrequest + \fee$ to a given request and no more with $\fee \leq \constgasmax$.
They will not continue to send money to \tcont without receiving a response, so that means that they cannot lose more than $\gasrequest + \constgasmax$
even if \tc is malicious and does not deliver data.
\end{proof}



