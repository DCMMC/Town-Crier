\section{Experiments}
\label{sec:experiments}

\begin{table*}[h]
\begin{tabular}{l|lllll|lllll|lllll}
\toprule
& \multicolumn{5}{c|}{\sf CashSettledPut} &
  \multicolumn{5}{c|}{\sf FlightIns} &
  \multicolumn{5}{c}{\sf SteamTrade} \\
    & \textbf{mean} & \% & $t_{\max}$ & $t_{\min}$ & $\sigma_t$ & \textbf{mean}
    & \% & $t_{\max}$ & $t_{\min}$ & $\sigma_t$ & \textbf{mean} & \% & $t_{\max}$
    & $t_{\min}$ & $\sigma_t$\\
\midrule
    Ctx. switch & 1.00 &  & 3.12 & 0.25 & 0.31 & 1.23 &  & 2.94 & 0.17 &
    0.32 & 1.17 &  & 3.25 & 0.36 & 0.35\\
    Web scraper & 157 &  & 258 & 135 & 18 & 482 &  & 600 & 418 & 31 & 576 &  &
    765 & 489 & 52\\
    Sign & 20.2 &  & 26.6 & 18.7 & 1.52 & 20.5 &  & 25.3 & 18.9 & 1.4 & 20.3 &
    & 24.8 & 18.8 & 1.28\\
    Serialization & 0.40 &  & 0.84 & 0.24 & 0.08 & 0.38 &  & 0.67 & 0.20 &
    0.08 & 0.39 &  & 0.65 & 0.24 & 0.09\\
\midrule
\midrule
    \textbf{Total} & 180 &  & 284 & 158 & 18 & 505 &  & 623 & 439
    & 31 & 599 &  & 787 & 510 & 52 \\
\bottomrule	
\end{tabular}
\caption{Running time of handling a request. We repeated the experiments for 5 times and
report the mean and standard deviation. Proportions are for means.\fan{complete}}
\label{tab:eval_profiling}
\end{table*}

\iffalse
\begin{table*}[ht]
\centering
\begin{tabular}{l|rr|rr|rr}
\toprule
& \multicolumn{2}{c|}{\sf CashSettledPut} &
  \multicolumn{2}{c|}{\sf FlightIns} &
  \multicolumn{2}{c}{\sf SteamTrade} \\
  & time(ms) & proportion & time(ms) & proportion  & time(ms) & proportion\\
\midrule
Context switch      & $0.68\pm 0.12$    & 0.37\%   
                    & $0.77\pm 0.07$    & 0.15\%    
                    & $0.89\pm 0.47$    & 0.10\%\\
%
Web scraper         & $172.07\pm 12.41$  & 94.20\%  
                    & $512.32\pm 44.66$  & 97.96\%   
                    & $913.73\pm 92.51$  & 98.83\%\\
%
Sign                & $9.71\pm 0.55$   & 5.32\%   
                    & $9.64\pm 0.59$   & 1.84\%    
                    & $9.65\pm 0.63$   & 1.04\%\\
%
Serialization       & $0.20\pm 0.04$    & 0.11\%   
                    & $0.25\pm 0.09$    & 0.05\%    
                    & $0.32\pm 0.10$    & 0.03\%\\
\midrule
Total               & $182.66\pm 12.7$  & 100.00\%    
                    & $522.98\pm 44.92$ & 100.00\% 
                    & $924.59\pm 92.63$ & 100.00\%\\
\bottomrule
\end{tabular}
\caption{Running time of handling a request. We repeated the experiments for 5 times and
report the mean and standard deviation. Proportions are for means.}
\label{tab:eval_profiling}
\end{table*}
\fi

We evaluated the performance of \tc on a Dell Inspiron 13-7359 laptop equipped
with an Intel i7-6500U CPU and 8.00GB memory.  This model is chosen 
because it is one of the few SGX-enabled systems available on the market at the
writing of this paper. Although the hosting platform is just moderately preferment, we
show that on a single host, the current implementation is able to handle 
transactions generated by Ethereum blockchain in real time. 
\elaine{todo: modify
the previous sentence 
after Fan's new experiments are done.}


\subsection{Enclave Response Time}
We measured the enclave response time for handling a request. Here ``enclave response time''
is defined as the difference between 1) the time 
the relay decides to send a request to an SGX enclave;
and 2) the time the relay gets a response back from the SGX enclave. 
For each application, we repeat the  
experiment 5 times, and report the mean and the standard deviation.  

Table \ref{tab:eval_profiling} summarizes the total enclave response time as
well as its breakdown.  The table suggests that for the three applications we
implemented the enclave response time ranges from {\bf 183 ms} to {\bf 925 ms}.
The response time is clearly dominated by the web scraper time, i.e., the time
it takes to fetch the requested information from a website.  Among the three
applications evaluated, {\sf SteamTrade} has the longest web scraper time, since
in the case of {\sf SteamTrade}, the web scraper must interact with the website
over multiple roundtrips to fetch the desired datagram.

\subsection{Transaction Throughput}
We performed a sequence of experiments running 1 to 20 enclaves 
concurrently
on a single SGX-enable laptop
machine, and investigated the transaction throughput 
enabled by a single SGX machine. 
Note that at most 20 \tc enclaves can be launched
on the specific machine model we used due to EPC memory
constraint.
Figure \ref{fig:trpt}
shows that for the three applications evaluated,
{\bf a single SGX machine can handle
15 to 74
tx/sec}.

We give several meaningful data points of comparison to show
why a single SGX machine suffices to handle the load of
today's blockchains: 
Ethereum as of today handles 
$< 1$ tx/sec on average. 
Bitcoin today handles
3 tx/sec, and 
its maximum throughput (when the full block size is utilized)
would be roughly 7 tx/sec.
We know of no measurement study that 
investigates the fundamental 
throughput bound of the Ethereum  peer-to-peer network.
However, for Bitcoin, it has been shown that without
redesigning the protocol, 
Bitcoin cannot scale beyond  
27 tx/sec~\cite{blockchainscaling}
%\elaine{double check this number} 
by simple reparametrization of its block size.
Therefore, Town Crier will not be a throughput 
bottleneck when used 
with decentralized blockchains --- it appears 
more imminent to scale up 
the blockchain protocols themselves.

Last but not the least, our experiments indicate
that {\it there is no noticeable slowdown in terms of enclave
response time when multiple enclaves are run} on a single machine.
\elaine{Fan: double check}

\begin{figure}[h]
  \resizebox {\columnwidth} {!}{
\begin{tikzpicture}
\begin{axis}[
    every axis/.append style={font=\small},
	legend pos=north west,
	xlabel=Number of enclaves on a single machine,
	ylabel=Throughput (tx/sec),
    ylabel near ticks,
]
\addplot+[error bars/.cd,y dir=both,y explicit] table[x=n,y=steam,y error=e-steam]{data.csv};
\addplot+[error bars/.cd,y dir=both,y explicit] table[x=n,y=flight,y error=e-flight]{data.csv};
\addplot+[error bars/.cd,y dir=both,y explicit] table[x=n,y=putop,y error=e-putop]{data.csv};
\addplot [dashed, domain=1:20, samples=20, thick, forget plot]{5.80*x};
\addplot [dashed, domain=1:20, samples=20, thick, forget plot]{2.00*x};
\addplot [dashed, domain=1:20, samples=20, thick]{1.20*x};
\legend{{\sf SteamTrade},{\sf FlightIns},{\sf CashSettledPut}, {\sf Linear Scaling}}
\end{axis}
\end{tikzpicture}
}
\caption{Throughput is measured on a single SGX-enabled machine. The x-axis is
the number of enclaves and the y-axis is the number of transactions processed per
second.  We ran five rounds of experiments and error bars show the standard
deviation.\fan{complete}}
\label{fig:trpt}
\end{figure}


\begin{table*}[ht]
\centering
\begin{tabular}{l|r|r|r}
\toprule
& \multicolumn{1}{c|}{\sf CashSettledPut} &
  \multicolumn{1}{c|}{\sf FlightIns} &
  \multicolumn{1}{c}{{\sf SteamTrade}${}^\dagger$} \\
%  & gas (cents) & gas (cents) & gas (cents) \\
\midrule
Deliver without Cancel & 3.95\textcent & 4.00\textcent & 4.30\textcent \\ 
Cancel arrived after Deliver & 4.90\textcent & 4.95\textcent & 5.25\textcent \\ 
Cancel without Deliver & 4.65\textcent & 4.70\textcent & 5.00\textcent \\ 
\bottomrule
\end{tabular}
\caption[caption]{{\bf Callback-independent} portion of gas expenditure in USD.
The difference between applications is due to the differing lengths of the input parameters.
The first two rows would also have to pay for $\dgcallback$,
but we do not include that cost as it would exist even if data acquisition were free.
\\\hspace{\textwidth}
${}^\dagger$ These numbers are for 1 item. Each additional item costs an additional 0.06\textcent.
}
\label{tab:eval_gas}
\end{table*}



\subsection{Gas Costs}
Currently 1 gas costs $5 / 10^8$ ether, so at the exchange rate of \$5 for 1 ether, \$1 buys 4 million gas.
Here we provide costs for the components of our implementation.

The callback-independent portion of {\bf Deliver} costs about \num[group-separator={,}]{35000} gas (0.9\textcent), so this is the value of $\constgasmin$.
We set $\constgasmax = \num[group-separator={,}]{3100000}$ gas (77.5\textcent) as this is approximately Ethereum's maximum {\tt GASLIMIT}.
The cost for executing {\bf Request} is approximately \num[group-separator={,}]{120000} gas (3\textcent) of fixed cost, 
plus \num[group-separator={,}]{2500} gas (0.06\textcent) for every 32 bytes of request parameters.
The cost for executing {\bf Cancel} is 62500 gas (1.55\textcent)
including the gas cost $\constgasinvokecancel$ and the refund $\constgascancel$ paid to \tcs should {\bf Deliver} be called after {\bf Cancel}.

Reflected in each concrete application, Figure \elaine{fill}
shows that the effective gas cost  
for the calling Town Crier service (not counting the gas cost for executing
user-defined callbacks)
ranges from \elaine{\bf ethan: fill} to \elaine{\bf ethan: fill}.



\subsection{Resilience against Component Compromise}
\label{subsec:hedging}
For the {\sf FlightIns} application, 
we implemented and evaluated two modes of majority voting:
\begin{itemize}[leftmargin=3mm]
\item
2-out-of-3 majority voting within the enclave which provides robustness
against data source compromise.
Specifically, in our experiments, 
the enclave scraped current stock prices 
from three different data sources, 
namely, Bloomberg, Google Finance and Yahoo Finance.
Our experiments suggest that  
the enclave response time is 
1743 ms in this case ({\it c.f.} ms, 
1058 ms, 423 ms and 262  ms for 
each data source).
At the moment, the three requests 
are sequential. In the future, we will investigate how to 
use SGX's thread mechanism to parallelize the requests --- and more importantly
the security implications of doing so.
Finally, there is no change in the gas cost when voting is done
inside the SGX enclave.
\fan{the numbers are bigger than Yahoo because Google and Bloomberg
doesn't have a clean API so the whole web page is downloaded.}
\item
2-out-of-3 majority voting within the requester contract,
which provides robustness against 
SGX compromise.
To support this, we ran three instances of SGX enclaves all scraping
the same data source.  
The main change in this scenario is that 
the gas cost would increase by a factor of 3 plus an additional 1.95\textcent.
So {\sf CashSettledPut} would cost 13.8\textcent\ for Deliver without Cancel.
The extra 1.95\textcent\ is because the client contract must store votes
until a winner is known and blockchain storage is expensive.
\end{itemize}


%\elaine{add some eval results here.}

\subsection{Offline Measurements}
%We characterize several measurements 
%performed during the offline phase, 
%include the cost for generating and verifying SGX attestations,
%as well as clock calibration   
%measurements.


%Recall that a user must verify  
%an SGX enclave's attestation offline to securely establish 
%the identity $\pkTC$. 
%Our experiments show that the 

Recall that a one-time setup operation is required 
for the enclave to be established, and an attestation generated. 
Our measurement suggests that the enclave establishment takes
\elaine{fill} ms, 
and the attestation generation takes 
83.4 ms (among which 
18.5 ms is spent 
on report generation, 
and 64.9 ms on quote generation).

Recall also that since SGX only reports a relative clock
with respect to some reference point,  
a user must perform offline clock calibration 
to translate the  relative clock values into absolute ones.
The clock precision is decided
by the end-to-end latency for performing 
this clock calibration. 
Our experiments show that the latency is \elaine{fill} ms 
between when a relay sends a clock calibration request
to the enclave, and when it obtains a response.
The majority of this \elaine{fill} ms is spent on
\elaine{blah operation}
which took \elaine{blah} ms.
In practice, the clock precision is also affected
by the wide-area network latency
which is typically in the \elaine{blah} range.

%Recall that the absolute time of the \encname is verified
%by including a signed time stamp in the attestation and letting 
%clients check it it in real time. Therefore the latency
%of attestation generation plus a round-trip time
%define the precision of the absolute clock. 
%We evaluated the cycles consumed in generating an attestation and
%signing a Unix time stamp.
%
%\begin{table}[ht]
%\centering
%\begin{tabular}{lr}
%\toprule
%  & time(ms) \\
%\midrule
%Report Generation & $18.46$ \\
%Quote Generation & $64.94$ \\
%Signing the time stamp & $11.50$ \\
%\bottomrule
%\end{tabular}
%\caption{Running time of generating \att}
%\label{tab:eval_att}
%\end{table}
%
%Table \ref{tab:eval_att} summarizes the running time break down of generating an
%attestation along with a signed time stamp.  Note that two steps are involved in
%generating \att: first a report is produced within the \encname; then, an
%attestation, as known as a quote, is produced by QE based on the report passed
%to it. Note that \att only need to be generated once throughout the lifetime of the
%enclave.
%
%
%
